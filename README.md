# Managing Flow Contract Audit Vouchers

This repository demonstrates how Flow contract auditors can use Flow CLI to generate and manage contract deployment [vouchers](https://flowscan.org/contract/A.e467b9dd11fa00df.FlowContractAudits/overview).

Currently, contract deployment access is limited to a specific set of accounts on Flow mainnet. To further open up access, we've introduced contract audit vouchers. If a contract code hash has an associated audit voucher, it can be deployed to the network by anyone (optionally to a determinstic account specified in the voucher). To generate audit vouchers you need to get authorized for `Auditor` access first. You can then use the transaction templates in this repository to get started generating vouchers.

## Requirements 

* [jq](https://stedolan.github.io/jq/) command-line JSON processor
    ```bash
    brew install jq
    ```
* [Flow CLI](https://github.com/onflow/flow-cli)
    ```bash
    brew install flow-cli
    ```

## Setup

1. Insert your account address and key into [flow.json](flow.json) account settings.

2. Initialize your account with `AuditorProxy`:
    ```bash
    flow transactions send transactions/init_auditor_proxy.cdc \
      --signer contract-auditor \
      --network mainnet
    ```
   >Make sure the init transaction succeeds. If you're initializing a new account, you might need to deposit some FLOW tokens before running the init transaction.
3. The administrator can now authorize access by depositing an `Auditor` capability into your account.

## Generating Vouchers

### Non-Recurrent (default)

The arguments passed are the target account address and full contract code.

Default expiry on [new_audit.cdc](transactions/new_audit.cdc) for single-use vouchers is 30 days. 

  ```bash
  flow transactions send transactions/new_audit.cdc \
    0xa6cd6531c4f72c4f \
    "$(jq -R -s '.' < audits/sample_contract.cdc)" \
    --network mainnet \
    --signer contract-auditor
  ```

The resulting transaction should contain a `A.e467b9dd11fa00df.FlowContractAudits.VoucherCreated` event with associated voucher data.

### Recurrent

Recurrent deployments are utility contracts that might be deployed to multiple accounts. 

No target account is specified and the default expiry is none.

The only needed argument is the full contract code.

  ```bash
  flow transactions send transactions/new_recurrent_audit.cdc \
    "$(jq -R -s '.' < audits/sample_contract.cdc)" \
    --network mainnet \
    --signer contract-auditor
  ```

The resulting transaction should contain a `A.e467b9dd11fa00df.FlowContractAudits.VoucherCreated` event with associated voucher data.

### Hashed Non-Recurrent (advanced)

This is the same as non-recurrent vouchers, but the audit transaction only contains the code hash (not the full contract source code).

This can be useful in two ways:
* Contracts that must not leak any information before deployment. The voucher is accessible by anyone, so it's possible
 for others to find out about an upcoming contract before deployment. The hashed voucher won't leak any information as
 it does not contain the full code on the audit transaction.
* Contracts that are too large to pass in one transaction.

Ideally, the non-hashed voucher generation transaction should be used if none of the above conditions apply to a contract. The
developer will be able to check the full code on the audit transaction to debug any code hash mismatches.

  ```bash
  flow transactions send transactions/new_audit_hashed.cdc \
    0xa6cd6531c4f72c4f \
    b4f6e303b74c0531c5e482d72719197732b80695684db999f70c244ec0da92c1 \
    --network mainnet \
    --signer contract-auditor
  ```

The resulting transaction should contain a `A.e467b9dd11fa00df.FlowContractAudits.VoucherCreated` event with associated voucher data.

## Getting All Vouchers

Returns list of currently active vouchers.

```bash
flow scripts execute scripts/get_vouchers.cdc --network mainnet
```

## Deleting Vouchers

The voucher key format is:

* `any-codehash` for recurrent vouchers
* `address-codehash` for non-recurrent vouchers

You can also use the get all vouchers script above to access the list of keys.

```bash
  flow transactions send transactions/remove_audit.cdc \
  "0xa6cd6531c4f72c4f-36f028580bb02cc8272a9a020f4200e346e276ae664e45ee80745574e2f5ab80" \
  --network mainnet \
  --signer contract-auditor
```

The resulting transaction should contain a `A.e467b9dd11fa00df.FlowContractAudits.VoucherRemoved` event with associated voucher data.

## Checking Contract Hash

You can also use online tools like [this](https://emn178.github.io/online-tools/sha3_256_checksum.html).

Contract code is hashed using SHA3-256.

```bash
flow scripts execute scripts/hash_code.cdc \
  "$(jq -R -s '.' < audits/sample_contract.cdc)" \
  --network mainnet
```

## Checking Audited Code

If the voucher was generated by full contract code, the code can be accessed on the audit transaction. This will help developers solve any voucher mismatch they might experience due to different code hashes.

```bash
flow transactions get d159a1b838a1b541f4b4a39be1056989637be753546dfec93c62cff4f9ae8a85 --network mainnet --include code
```
